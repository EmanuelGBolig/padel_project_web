{% extends "base.html" %}
{% load static %}
{% block head_title %}
    Programación General - {{ organizacion.nombre }}
{% endblock head_title %}
{% block content %}
    <div class="container mx-auto px-4 py-8 max-w-4xl" data-theme="business">
        <div class="bg-black rounded-3xl p-6 md:p-10 shadow-lg">
            <!-- HEADER -->
            <div class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-6 border-b border-base-content/10 pb-6">
                <div class="flex-1">
                    <h1 class="text-3xl font-black text-white tracking-wider uppercase mb-1 drop-shadow-md">PROGRAMACIÓN GENERAL</h1>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 mt-2">
                        <h2 class="text-xl font-bold text-base-content/60 uppercase tracking-widest">{{ organizacion.nombre }}</h2>
                        {% if fecha_seleccionada %}
                            <span class="hidden sm:inline-block text-base-content/40 mx-2">|</span>
                            <div class="badge badge-primary badge-outline text-sm font-bold uppercase tracking-wider py-3 px-4">
                                Torneos del {{ fecha_seleccionada|date:"d M Y" }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-end sm:items-center gap-3 shrink-0">
                    <!-- Selector de Fecha -->
                    {% if fechas_disponibles %}
                        <form method="get" class="w-full sm:w-auto">
                            <select name="fecha"
                                    class="select select-bordered select-sm md:select-md w-full sm:w-auto bg-base-200 text-base-content font-semibold shadow-inner"
                                    onchange="this.form.submit()">
                                <option value="" disabled {% if not fecha_seleccionada %}selected{% endif %}>Seleccionar fin de semana</option>
                                {% for fecha in fechas_disponibles %}
                                    <option value="{{ fecha|date:'Y-m-d' }}"
                                            {% if fecha_seleccionada == fecha %}selected{% endif %}>
                                        {{ fecha|date:"d M Y" }}
                                    </option>
                                {% endfor %}
                            </select>
                        </form>
                    {% endif %}
                    <a href="{% url 'accounts:organizador_detalle' organizacion.pk %}"
                       class="btn btn-sm md:btn-md btn-outline text-xs w-full sm:w-auto">Volver al Perfil</a>
                </div>
            </div>
            <!-- TORNEOS DE ESTA FECHA -->
            {% if torneos_bloque %}
                <div class="flex flex-wrap gap-2 mb-8 items-center bg-base-200/50 p-4 rounded-2xl border border-base-content/5">
                    <span class="text-xs uppercase tracking-widest opacity-50 font-bold mr-2">Torneos en esta fecha:</span>
                    {% for t in torneos_bloque %}
                        <a href="{% url 'torneos:detail' t.pk %}"
                           class="badge badge-neutral hover:badge-primary transition-colors py-3 shadow-sm border border-base-content/10">
                            {{ t.nombre }}
                        </a>
                    {% endfor %}
                </div>
            {% endif %}
            <!-- FECHAS (LISTA AGRUPADA) -->
            <div class="space-y-12 pb-4">
                {% regroup partidos_con_fecha by fecha_hora|date:"Y-m-d H:i" as partidos_por_hora %}
                {% for agrupacion in partidos_por_hora %}
                    <div class="space-y-4">
                        <!-- SEPARADOR DE FECHA/HORA -->
                        <div class="flex items-center justify-center relative my-6">
                            <!-- Línea horizontal de fondo verde muy sutil -->
                            <div class="absolute inset-x-0 h-px bg-emerald-500/20"></div>
                            <!-- Badge central -->
                            <div class="relative z-10 flex text-sm font-bold shadow-lg overflow-hidden rounded-full">
                                <div class="bg-emerald-500 text-base-100 px-4 py-1.5 flex items-center justify-center leading-none">
                                    {{ agrupacion.grouper|slice:"11:16" }} <!-- Extraer solo hora Ej: 09:00 -->
                                </div>
                                <div class="bg-white text-base-100 px-5 py-1.5 flex items-center justify-center leading-none">
                                    {{ agrupacion.list.0.fecha_hora|date:"d/m/Y" }}
                                </div>
                            </div>
                        </div>
                        <!-- PARTIDOS DE ESA HORA -->
                        <div class="grid gap-4">
                            {% for partido in agrupacion.list %}
                                <div class="bg-[#15191e] border border-base-content/10 rounded-2xl p-4 md:p-6 flex flex-col md:flex-row items-center justify-between shadow-sm transition-all hover:bg-[#1a1f26] hover:border-emerald-500/30 relative overflow-hidden group">
                                    <!-- Torneo Badge Lateral -->
                                    <div class="md:absolute top-0 right-0 left-0 md:left-auto md:w-32 bg-emerald-500/10 md:bg-emerald-500/20 md:h-full flex items-center justify-center py-2 md:py-0 px-2 rounded-t-2xl md:rounded-l-none md:rounded-r-2xl mb-4 md:mb-0 transition-colors group-hover:bg-emerald-500/30 text-center">
                                        <a href="{% url 'torneos:detail' partido.torneo_pk %}"
                                           class="text-[0.65rem] uppercase font-bold text-emerald-400 hover:text-emerald-300 tracking-wider">
                                            {{ partido.torneo_nombre }}
                                        </a>
                                    </div>
                                    <!-- Contenido Principal -->
                                    <div class="flex flex-col md:flex-row items-center justify-between w-full md:pr-32">
                                        <!-- Equipo 1 -->
                                        <div class="flex-1 text-center md:text-left w-full space-y-1.5 mb-4 md:mb-0">
                                            {% if partido.equipo1 %}
                                                <p class="text-[1.1rem] md:text-lg text-base-content font-medium opacity-80 truncate">
                                                    {{ partido.equipo1.jugador1.full_name|default:"-" }}
                                                </p>
                                                <p class="text-[1.1rem] md:text-lg text-white font-bold truncate">
                                                    {{ partido.equipo1.jugador2.full_name|default:"-" }}
                                                </p>
                                            {% else %}
                                                <p class="text-[1.1rem] md:text-lg text-base-content/50 font-medium italic select-none">
                                                    {{ partido.placeholder_e1|default:"Por definir" }}
                                                </p>
                                                <p class="text-[1.1rem] md:text-lg text-base-content/50 font-medium italic select-none">-</p>
                                            {% endif %}
                                        </div>
                                        <!-- VS Centro -->
                                        <div class="flex flex-col items-center justify-center shrink-0 px-6 w-full md:w-auto mb-4 md:mb-0">
                                            <span class="text-[0.65rem] tracking-[0.2em] text-base-content/50 font-semibold uppercase mb-1 whitespace-nowrap">
                                                {{ partido.division_nombre }} {{ partido.categoria_display }}
                                            </span>
                                            <div class="text-3xl font-black text-white px-2 tracking-widest drop-shadow-md">VS</div>
                                            <span class="text-[0.6rem] tracking-wider text-base-content/50 font-medium mt-1 uppercase text-center max-w-[120px]">
                                                {{ partido.fase }}
                                                <br>
                                                {{ partido.descripcion_partido }}
                                            </span>
                                        </div>
                                        <!-- Equipo 2 -->
                                        <div class="flex-1 text-center md:text-right w-full space-y-1.5">
                                            {% if partido.equipo2 %}
                                                <p class="text-[1.1rem] md:text-lg text-base-content font-medium opacity-80 truncate">
                                                    {{ partido.equipo2.jugador1.full_name|default:"-" }}
                                                </p>
                                                <p class="text-[1.1rem] md:text-lg text-white font-bold truncate">
                                                    {{ partido.equipo2.jugador2.full_name|default:"-" }}
                                                </p>
                                            {% else %}
                                                <p class="text-[1.1rem] md:text-lg text-base-content/50 font-medium italic select-none">
                                                    {{ partido.placeholder_e2|default:"Por definir" }}
                                                </p>
                                                <p class="text-[1.1rem] md:text-lg text-base-content/50 font-medium italic select-none">-</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center py-10 opacity-70">
                        <p>Aún no hay partidos con fecha y hora programada en ningún torneo activo.</p>
                    </div>
                {% endfor %}
                <!-- PARTIDOS POR DEFINIR (SIN FECHA) -->
                {% if partidos_sin_fecha %}
                    <div class="space-y-4 pt-10">
                        <!-- SEPARADOR POR DEFINIR -->
                        <div class="flex items-center justify-center relative my-6">
                            <!-- Línea horizontal de fondo naranja muy sutil -->
                            <div class="absolute inset-x-0 h-px bg-warning/20"></div>
                            <!-- Badge central -->
                            <div class="relative z-10 flex text-sm font-bold shadow-lg overflow-hidden rounded-full">
                                <div class="bg-warning text-warning-content px-6 py-1.5 flex items-center justify-center leading-none uppercase tracking-wider">
                                    Por definir
                                </div>
                            </div>
                        </div>
                        <!-- PARTIDOS SIN ESTABLECER HORA -->
                        <div class="grid gap-4 opacity-80">
                            {% for partido in partidos_sin_fecha %}
                                <div class="bg-[#15191e] border border-base-content/10 rounded-2xl p-4 md:p-6 flex flex-col md:flex-row items-center justify-between shadow-sm transition-all hover:bg-[#1a1f26] hover:border-emerald-500/30 relative overflow-hidden group">
                                    <!-- Torneo Badge Lateral -->
                                    <div class="md:absolute top-0 right-0 left-0 md:left-auto md:w-32 bg-warning/10 md:bg-warning/20 md:h-full flex items-center justify-center py-2 md:py-0 px-2 rounded-t-2xl md:rounded-l-none md:rounded-r-2xl mb-4 md:mb-0 transition-colors group-hover:bg-warning/30 text-center">
                                        <a href="{% url 'torneos:detail' partido.torneo_pk %}"
                                           class="text-[0.65rem] uppercase font-bold text-warning hover:text-warning-content tracking-wider">
                                            {{ partido.torneo_nombre }}
                                        </a>
                                    </div>
                                    <!-- Contenido Principal -->
                                    <div class="flex flex-col md:flex-row items-center justify-between w-full md:pr-32">
                                        <!-- Equipo 1 -->
                                        <div class="flex-1 text-center md:text-left w-full space-y-1.5 mb-4 md:mb-0">
                                            {% if partido.equipo1 %}
                                                <p class="text-[1.1rem] md:text-lg text-base-content font-medium opacity-80 truncate">
                                                    {{ partido.equipo1.jugador1.full_name|default:"-" }}
                                                </p>
                                                <p class="text-[1.1rem] md:text-lg text-white font-bold truncate">
                                                    {{ partido.equipo1.jugador2.full_name|default:"-" }}
                                                </p>
                                            {% else %}
                                                <p class="text-[1.1rem] md:text-lg text-base-content/40 font-medium italic select-none">
                                                    {{ partido.placeholder_e1|default:"Por definir" }}
                                                </p>
                                            {% endif %}
                                        </div>
                                        <!-- VS Centro -->
                                        <div class="flex flex-col items-center justify-center shrink-0 px-6 w-full md:w-auto mb-4 md:mb-0">
                                            <span class="text-[0.65rem] tracking-[0.2em] text-base-content/50 font-semibold uppercase mb-1 whitespace-nowrap">
                                                {{ partido.division_nombre }} {{ partido.categoria_display }}
                                            </span>
                                            <div class="text-3xl font-black text-white/50 px-2 tracking-widest">VS</div>
                                            <span class="text-[0.6rem] tracking-wider text-base-content/50 font-medium mt-1 uppercase text-center max-w-[120px]">
                                                {{ partido.fase }}
                                                <br>
                                                {{ partido.descripcion_partido }}
                                            </span>
                                        </div>
                                        <!-- Equipo 2 -->
                                        <div class="flex-1 text-center md:text-right w-full space-y-1.5">
                                            {% if partido.equipo2 %}
                                                <p class="text-[1.1rem] md:text-lg text-base-content font-medium opacity-80 truncate">
                                                    {{ partido.equipo2.jugador1.full_name|default:"-" }}
                                                </p>
                                                <p class="text-[1.1rem] md:text-lg text-white font-bold truncate">
                                                    {{ partido.equipo2.jugador2.full_name|default:"-" }}
                                                </p>
                                            {% else %}
                                                <p class="text-[1.1rem] md:text-lg text-base-content/40 font-medium italic select-none">
                                                    {{ partido.placeholder_e2|default:"Por definir" }}
                                                </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock content %}
