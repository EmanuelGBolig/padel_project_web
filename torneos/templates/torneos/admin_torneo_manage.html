{% extends "base.html" %}
{% load torneo_extras %}
{% block title %}
    Gestionar: {{ torneo.nombre }}
{% endblock title %}
{% block content %}
    <div class="space-y-8">
        <!-- 1. HEADER DEL TORNEO -->
        <div class="bg-base-200/50 p-4 md:p-8 rounded-3xl border border-base-300/50">
            <div class="flex flex-col md:flex-row justify-between items-start gap-6">
                <div>
                    <h1 class="text-3xl font-black text-base-content">{{ torneo.nombre }}</h1>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <div class="badge badge-lg badge-secondary">{{ torneo.division.nombre }}</div>
                        <div class="badge badge-lg badge-accent">{{ torneo.get_estado_display }}</div>
                        <div class="badge badge-lg badge-primary badge-outline">{{ torneo.get_tipo_torneo_display }}</div>
                    </div>
                </div>
                <a href="{% url 'torneos:admin_editar' torneo.pk %}"
                   class="btn btn-ghost btn-sm gap-2 text-base-content/70 hover:text-primary">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke-width="1.5"
                         stroke="currentColor"
                         class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Configuración
                </a>
            </div>
            <div class="divider"></div>
            <!-- Acciones Torneo -->
            <form method="post" class="flex flex-wrap gap-3 w-full">
                {% csrf_token %}
                {% if torneo.estado == 'AB' %}
                    <button type="submit"
                            name="action"
                            value="iniciar_torneo"
                            class="btn btn-success text-white gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="1.5"
                             stroke="currentColor"
                             class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
                        </svg>
                        Iniciar Torneo y Generar Grupos
                    </button>
                {% elif torneo.estado == 'EJ' %}
                    {% if todos_grupos_cargados and not fase_eliminatoria_existente %}
                        <button type="submit"
                                name="action"
                                value="generar_octavos"
                                class="btn btn-primary gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke-width="1.5"
                                 stroke="currentColor"
                                 class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0V5.625a2.25 2.25 0 11-4.5 0v9.75m4.5 0h.75a2.25 2.25 0 012.25 2.25v3.375M9.497 14.625h-.75a2.25 2.25 0 01-2.25-2.25V5.625a2.25 2.25 0 014.5 0v9.75" />
                            </svg>
                            Calcular Clasificación y Generar Bracket
                        </button>
                    {% elif not fase_eliminatoria_existente %}
                        <div role="alert" class="alert alert-warning py-2 max-w-md">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 class="stroke-current h-6 w-6"
                                 fill="none"
                                 viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <span>Faltan <strong>{{ partidos_grupo_pendientes }}</strong> partidos de grupo.</span>
                        </div>
                    {% endif %}
                    <button type="submit"
                            name="action"
                            value="finalizar_torneo"
                            class="btn btn-error text-white ml-auto">Finalizar Torneo</button>
                {% endif %}
            </form>
        </div>
        <!-- SEARCH BAR -->
        {% if grupos or fase_eliminatoria_existente %}
            <div class="form-control w-full max-w-md mx-auto mb-6">
                <div class="relative">
                    <input type="text"
                           id="adminSearchInput"
                           placeholder="Buscar equipo, grupo o ronda..."
                           class="input input-bordered w-full pr-10 pl-10" />
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-base-content/50">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="1.5"
                             stroke="currentColor"
                             class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                        </svg>
                    </div>
                    <button class="absolute right-0 top-0 rounded-l-none btn btn-ghost btn-square"
                            onclick="document.getElementById('adminSearchInput').value = ''; document.getElementById('adminSearchInput').dispatchEvent(new Event('input'));">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="1.5"
                             stroke="currentColor"
                             class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        {% endif %}
        <!-- 1.5 INSCRIPCIONES (Solo visible si está ABIERTO) -->
        {% if torneo.estado == 'AB' %}
            <div class="bg-base-200/50 p-4 md:p-8 rounded-3xl border border-base-300/50">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                    <h2 class="text-2xl font-bold text-base-content flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="2"
                             stroke="currentColor"
                             class="w-6 h-6 text-primary">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                        </svg>
                        Equipos Inscritos ({{ inscripciones.count }})
                    </h2>
                    {% if torneo.forzar_grupos_de_3 %}
                        <form method="post" action="" class="w-full md:w-auto">
                            {% csrf_token %}
                            <div class="flex flex-col sm:flex-row gap-2 w-full">
                                <input type="text"
                                       name="nombre_dummy_custom"
                                       placeholder="Nombre personalizado (opcional)"
                                       class="input input-sm input-bordered w-full sm:w-64" />
                                <button type="submit"
                                        name="action"
                                        value="agregar_dummy"
                                        class="btn btn-sm btn-primary gap-2 whitespace-nowrap">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         fill="none"
                                         viewBox="0 0 24 24"
                                         stroke-width="1.5"
                                         stroke="currentColor"
                                         class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                    </svg>
                                    Agregar Pareja Libre
                                </button>
                            </div>
                        </form>
                    {% endif %}
                </div>
                {% if inscripciones %}
                    <div class="overflow-x-auto">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Equipo</th>
                                    <th>Categoría</th>
                                    <th>Fecha Inscripción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inscripcion in inscripciones %}
                                    <tr class="hover">
                                        <td>{{ forloop.counter }}</td>
                                        <td class="font-bold">
                                            {% if inscripcion.equipo.es_dummy %}
                                                <span class="badge badge-warning gap-1">
                                                    {{ inscripcion.equipo.nombre }}
                                                    <span class="text-xs opacity-70">(Dummy)</span>
                                                </span>
                                            {% else %}
                                                {{ inscripcion.equipo.nombre }}
                                            {% endif %}
                                        </td>
                                        <td>{{ inscripcion.equipo.get_categoria_display }}</td>
                                        <td class="text-sm opacity-70">{{ inscripcion.fecha_inscripcion|date:"d/m/Y H:i" }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 24 24"
                             class="stroke-current shrink-0 w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        <span>No hay equipos inscritos aún.</span>
                    </div>
                {% endif %}
            </div>
        {% endif %}
        <!-- 2. FASE DE GRUPOS -->
        {% if torneo.estado == 'EJ' and grupos %}
            <section class="bg-base-200/50 p-4 md:p-8 rounded-3xl border border-base-300/50">
                <div class="flex items-center gap-4 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 24 24"
                             stroke-width="2"
                             stroke="currentColor"
                             class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-base-content">Fase de Grupos</h2>
                </div>
                <div class="space-y-2" id="groupsContainer">
                    {% for grupo in grupos %}
                        <div class="collapse collapse-arrow bg-base-100 border border-base-300 group-item shadow-sm">
                            <input type="checkbox" class="group-checkbox" />
                            <div class="collapse-title text-xl font-medium flex justify-between items-center pr-14 sm:pr-12">
                                <span class="group-name">{{ grupo.nombre }}</span>
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center gap-2">
                                        <!-- Botones y Acciones existentes -->
                                        <form method="post"
                                              class="inline-block relative z-30"
                                              onclick="event.stopPropagation();"
                                              onsubmit="return confirm('¿Avanzar clasificados del {{ grupo.nombre }} al cuadro final?')">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="avanzar_grupo">
                                            <input type="hidden" name="grupo_id" value="{{ grupo.pk }}">
                                            {% setvar grupo_terminado = True %}
                                            {% for p in grupo.partidos_grupo.all %}
                                                {% if not p.ganador %}
                                                    {% setvar grupo_terminado = False %}
                                                {% endif %}
                                            {% endfor %}
                                            <div class="tooltip tooltip-left"
                                                 data-tip="{% if grupo_terminado %}Mandar ganadores al cuadro{% else %}Faltan resultados por cargar en el grupo{% endif %}">
                                                <button type="submit"
                                                        onclick="event.stopPropagation();"
                                                        class="btn btn-sm {% if grupo_terminado %}btn-success{% else %}btn-disabled{% endif %} gap-2 relative z-30"
                                                        {% if not grupo_terminado %}disabled{% endif %}>
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         fill="none"
                                                         viewBox="0 0 24 24"
                                                         stroke-width="1.5"
                                                         stroke="currentColor"
                                                         class="w-4 h-4">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 8.25V18a2.25 2.25 0 0 0 2.25 2.25h13.5A2.25 2.25 0 0 0 21 18V8.25m-18 0V6a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 6v2.25m-18 0h18M5.25 9.75h13.5m-13.5 3h13.5m-13.5 3h13.5" />
                                                    </svg>
                                                    <span class="hidden md:inline">Avanzar Clasificados</span>
                                                </button>
                                            </div>
                                        </form>
                                        <button class="btn btn-sm btn-square btn-ghost text-warning z-20"
                                                hx-get="{% url 'torneos:swap_group_teams' grupo.pk %}"
                                                hx-target="#schedule_modal_content"
                                                onclick="event.stopPropagation(); schedule_modal.showModal()"
                                                title="Intercambiar Equipos">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                 fill="none"
                                                 viewBox="0 0 24 24"
                                                 stroke-width="1.5"
                                                 stroke="currentColor"
                                                 class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                                            </svg>
                                        </button>
                                        <span class="text-sm font-normal opacity-70 hidden sm:inline">Ver Partidos</span>
                                    </div>
                                </div>
                                <div class="collapse-content">
                                    <!-- Configuración de Grupo (Fecha Default) -->
                                    <div class="flex justify-between items-center bg-base-200/50 p-3 rounded-lg mb-4 mt-2">
                                        <span class="text-xs font-bold uppercase opacity-50 tracking-wider">Configuración del Grupo</span>
                                        <form method="post" class="flex items-center gap-2">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="set_grupo_date">
                                            <input type="hidden" name="grupo_id" value="{{ grupo.pk }}">
                                            <label class="label-text text-xs whitespace-nowrap">Fecha Estándar:</label>
                                            <input type="date"
                                                   name="fecha_inicio_default"
                                                   value="{{ grupo.fecha_inicio_default|date:'Y-m-d'|default:'' }}"
                                                   class="input input-xs input-bordered w-auto"
                                                   onchange="this.form.submit()">
                                        </form>
                                    </div>
                                    <!-- Tabla Posiciones (Compacta) -->
                                    <div class="overflow-x-auto mb-4 bg-base-200 rounded-lg p-2">
                                        <h4 class="text-sm font-bold mb-2 opacity-70">Tabla de Posiciones</h4>
                                        <table class="table table-zebra table-xs w-full text-center">
                                            <thead>
                                                <tr>
                                                    <th class="text-left">Equipo</th>
                                                    <th>PG</th>
                                                    <th>DS</th>
                                                    <th>DG</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in grupo.tabla.all %}
                                                    <tr class="{% if forloop.counter <= torneo.equipos_por_grupo %}font-bold text-success{% endif %}">
                                                        <td class="text-left filter-text">
                                                            <span class="opacity-50 mr-1">{{ forloop.counter }}.</span>
                                                            {% get_team_code item.equipo torneo %}
                                                        </td>
                                                        <td>{{ item.partidos_ganados }}</td>
                                                        <td>{{ item.diferencia_sets }}</td>
                                                        <td>{{ item.diferencia_games }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Partidos del Grupo -->
                                    <div class="flex flex-col gap-2 w-full">
                                        <h4 class="text-sm font-bold mb-2 opacity-70">Partidos</h4>
                                        {% for partido in grupo.partidos_grupo.all %}
                                            <div class="collapse collapse-plus bg-base-200 border border-base-300 match-item w-full">
                                                <input type="checkbox" />
                                                <div class="collapse-title text-sm font-medium flex justify-between items-center pr-8 min-h-[3rem] py-2">
                                                    <div class="flex flex-col w-full">
                                                        <div class="flex justify-between items-center w-full filter-text gap-2">
                                                            <span class="flex-1 w-0 text-right break-words leading-tight {% if partido.ganador == partido.equipo1 %}text-success font-bold{% endif %}">
                                                                {% get_team_display partido.equipo1 torneo %}
                                                            </span>
                                                            <span class="text-xs opacity-50 shrink-0">vs</span>
                                                            <span class="flex-1 w-0 text-left break-words leading-tight {% if partido.ganador == partido.equipo2 %}text-success font-bold{% endif %}">
                                                                {% get_team_display partido.equipo2 torneo %}
                                                            </span>
                                                        </div>
                                                        {% if partido.fecha_hora %}
                                                            <div class="text-xs text-center mt-1 opacity-70 font-mono">{{ partido.fecha_hora|date:"d/m H:i" }}</div>
                                                        {% endif %}
                                                        {% if partido.ganador %}
                                                            <div class="text-xs text-center mt-1 text-primary font-bold">
                                                                Resultado: {{ partido.e1_sets_ganados }}-{{ partido.e2_sets_ganados }}
                                                                <span class="opacity-70 font-normal">({{ partido.resultado }})</span>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="collapse-content flex justify-center items-center pt-2">
                                                    <button class="btn btn-sm btn-primary"
                                                            hx-get="{% url 'torneos:cargar_resultado_grupo' partido.pk %}"
                                                            hx-target="#modal_content"
                                                            onclick="resultado_modal.showModal()">
                                                        {% if partido.ganador %}
                                                            Editar Resultado
                                                        {% else %}
                                                            Cargar Resultado
                                                        {% endif %}
                                                    </button>
                                                    <button class="btn btn-sm btn-ghost text-info"
                                                            hx-get="{% url 'torneos:schedule_partido_grupo' partido.pk %}"
                                                            hx-target="#schedule_modal_content"
                                                            onclick="schedule_modal.showModal()">
                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                             fill="none"
                                                             viewBox="0 0 24 24"
                                                             stroke-width="1.5"
                                                             stroke="currentColor"
                                                             class="w-5 h-5">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0h18M5.25 12h13.5h-13.5v4.5h13.5" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}
            <!-- 3. BRACKET -->
            {% if fase_eliminatoria_existente %}
                <section class="bg-base-200/50 p-4 md:p-8 rounded-3xl border border-base-300/50">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-10 h-10 rounded-xl bg-secondary/10 flex items-center justify-center text-secondary shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke-width="2"
                                 stroke="currentColor"
                                 class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0V5.625a2.25 2.25 0 11-4.5 0v9.75m4.5 0h.75a2.25 2.25 0 012.25 2.25v3.375M9.497 14.625h-.75a2.25 2.25 0 01-2.25-2.25V5.625a2.25 2.25 0 014.5 0v9.75" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-base-content">Fase Eliminatoria</h2>
                    </div>
                    <div class="space-y-4" id="bracketContainer">
                        {% regroup partidos_eliminacion|dictsort:"ronda" by ronda as rondas_list %}
                        {% for ronda in rondas_list %}
                            <div class="collapse collapse-arrow bg-base-100 border border-base-300 round-item shadow-sm">
                                <input type="checkbox" class="round-checkbox" />
                                <div class="collapse-title text-xl font-medium flex justify-between items-center pr-14 sm:pr-12">
                                    <span class="round-name flex items-center gap-2">{% nombre_ronda_dinamico ronda.grouper total_rondas %}</span>
                                    <span class="text-sm font-normal opacity-70 hidden sm:inline">Ver Partidos</span>
                                </div>
                                <div class="collapse-content">
                                    <div class="space-y-2 mt-2">
                                        {% for partido in ronda.list %}
                                            <div class="collapse collapse-plus bg-base-200 border border-base-300 match-item">
                                                <input type="checkbox" />
                                                <div class="collapse-title text-sm font-medium flex justify-between items-center pr-8">
                                                    <div class="flex flex-col w-full">
                                                        <div class="flex justify-between items-center w-full filter-text gap-2">
                                                            <span class="flex-1 w-0 text-right break-words leading-tight {% if partido.ganador == partido.equipo1 %}text-success font-bold{% endif %}">
                                                                {% get_team_display partido.equipo1 torneo %}
                                                            </span>
                                                            <span class="text-xs opacity-50 shrink-0">vs</span>
                                                            <span class="flex-1 w-0 text-left break-words leading-tight {% if partido.ganador == partido.equipo2 %}text-success font-bold{% endif %}">
                                                                {% get_team_display partido.equipo2 torneo %}
                                                            </span>
                                                        </div>
                                                        {% if partido.fecha_hora %}
                                                            <div class="text-xs text-center mt-1 opacity-70 font-mono">{{ partido.fecha_hora|date:"d/m H:i" }}</div>
                                                        {% endif %}
                                                        {% if partido.ganador %}
                                                            <div class="text-xs text-center mt-1 text-primary font-bold">{{ partido.resultado }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="collapse-content flex justify-center items-center pt-2">
                                                    {% if partido.equipo1 and partido.equipo2 %}
                                                        <button class="btn btn-sm btn-primary"
                                                                hx-get="{% url 'torneos:admin_partido_resultado' partido.pk %}"
                                                                hx-target="#modal_content"
                                                                onclick="resultado_modal.showModal()">
                                                            {% if partido.ganador %}
                                                                Editar Resultado
                                                            {% else %}
                                                                Cargar Resultado
                                                            {% endif %}
                                                        </button>
                                                    {% else %}
                                                        <p class="text-sm opacity-50 italic mr-2">Esperando rivales...</p>
                                                    {% endif %}
                                                    <button class="btn btn-sm btn-ghost text-info"
                                                            hx-get="{% url 'torneos:schedule_partido' partido.pk %}"
                                                            hx-target="#schedule_modal_content"
                                                            onclick="schedule_modal.showModal()">
                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                             fill="none"
                                                             viewBox="0 0 24 24"
                                                             stroke-width="1.5"
                                                             stroke="currentColor"
                                                             class="w-5 h-5">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0h18M5.25 12h13.5h-13.5v4.5h13.5" />
                                                        </svg>
                                                    </button>
                                                    <button class="btn btn-sm btn-ghost text-warning"
                                                            hx-get="{% url 'torneos:replace_partido_teams' partido.pk %}"
                                                            hx-target="#schedule_modal_content"
                                                            onclick="schedule_modal.showModal()"
                                                            title="Reemplazar Equipos">
                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                             fill="none"
                                                             viewBox="0 0 24 24"
                                                             stroke-width="1.5"
                                                             stroke="currentColor"
                                                             class="w-5 h-5">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </section>
            {% endif %}
            <!-- MODAL RESULTADO -->
            <dialog id="resultado_modal" class="modal">
                <div class="modal-box max-w-lg p-0 overflow-hidden">
                    <div id="modal_content">
                        <div class="p-8 space-y-4">
                            <div class="h-8 w-64 skeleton mb-6"></div>
                            <div class="space-y-3">
                                <div class="h-16 w-full skeleton"></div>
                                <div class="h-16 w-full skeleton"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-8">
                                <div class="h-12 skeleton"></div>
                                <div class="h-12 skeleton"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button>close</button>
                </form>
            </dialog>
            <!-- SCHEDULE MODAL -->
            <dialog id="schedule_modal" class="modal">
                <div class="modal-box">
                    <div id="schedule_modal_content">
                        <div class="p-8 space-y-4">
                            <div class="h-8 w-48 skeleton mb-6"></div>
                            <div class="h-12 w-full skeleton"></div>
                            <div class="h-12 w-full skeleton"></div>
                            <div class="h-12 w-32 skeleton ml-auto mt-6"></div>
                        </div>
                    </div>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button>close</button>
                </form>
            </dialog>
            <script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('adminSearchInput');
        if (!searchInput) return;

        searchInput.addEventListener('input', function (e) {
            const term = e.target.value.toLowerCase().trim();

            // 1. Filtrar Grupos
            const groupItems = document.querySelectorAll('.group-item');
            groupItems.forEach(group => {
                const groupName = group.querySelector('.group-name').textContent.toLowerCase();
                const matches = group.querySelectorAll('.match-item');
                let hasMatch = false;

                // Check matches inside group
                matches.forEach(match => {
                    const text = match.querySelector('.filter-text').textContent.toLowerCase();
                    if (text.includes(term)) {
                        match.style.display = '';
                        hasMatch = true;
                    } else {
                        match.style.display = 'none';
                    }
                });

                // Check table rows inside group
                const tableRows = group.querySelectorAll('tbody tr');
                tableRows.forEach(row => {
                    const text = row.querySelector('.filter-text').textContent.toLowerCase();
                    if (text.includes(term)) {
                        hasMatch = true;
                    }
                });

                // Show/Hide Group
                if (term === '' || groupName.includes(term) || hasMatch) {
                    group.style.display = '';
                    // Expand if searching and match found inside
                    if (term !== '' && hasMatch) {
                        group.querySelector('.group-checkbox').checked = true;
                    }
                } else {
                    group.style.display = 'none';
                }
            });

            // 2. Filtrar Rondas (Bracket)
            const roundItems = document.querySelectorAll('.round-item');
            roundItems.forEach(round => {
                const roundName = round.querySelector('.round-name').textContent.toLowerCase();
                const matches = round.querySelectorAll('.match-item');
                let hasMatch = false;

                matches.forEach(match => {
                    const text = match.querySelector('.filter-text').textContent.toLowerCase();
                    if (text.includes(term)) {
                        match.style.display = '';
                        hasMatch = true;
                    } else {
                        match.style.display = 'none';
                    }
                });

                if (term === '' || roundName.includes(term) || hasMatch) {
                    round.style.display = '';
                    if (term !== '' && hasMatch) {
                        round.querySelector('.round-checkbox').checked = true;
                    }
                } else {
                    round.style.display = 'none';
                }
            });
        });
    });
            </script>
        </div>
    {% endblock content %}
